<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>R | A perfect autumn day</title>
    <link>/tags/r/</link>
      <atom:link href="/tags/r/index.xml" rel="self" type="application/rss+xml" />
    <description>R</description>
    <generator>Source Themes Academic (https://sourcethemes.com/academic/)</generator><language>en-us</language><copyright>© 2019</copyright><lastBuildDate>Sun, 30 Jun 2019 00:00:00 +0900</lastBuildDate>
    <image>
      <url>/img/icon-192.png</url>
      <title>R</title>
      <link>/tags/r/</link>
    </image>
    
    <item>
      <title>How to add annotation (ex. KEGG orthology) box to a plot in ggplot2</title>
      <link>/post/annotation/</link>
      <pubDate>Sun, 30 Jun 2019 00:00:00 +0900</pubDate>
      <guid>/post/annotation/</guid>
      <description>&lt;p&gt;またまたRネタである．グラフに注釈をつけたくなることがあるが，なかなか見映えのする注釈をつけるのは難しい．最近，それなりの方法を見つけたので，まとめておく．例として，代謝経路の変化を縦型の折れ線グラフで描きKEGG orthologyによって分類したグラフを作成してみる．うーむ，自分で書いていてなんだが，マニアックなネタである．．．(^^;;;&lt;/p&gt;

&lt;p&gt;ま，備忘録として書いておこう．&lt;/p&gt;

&lt;div class=&#34;ox-hugo-toc toc&#34;&gt;
&lt;div&gt;&lt;/div&gt;

&lt;div class=&#34;heading&#34;&gt;Table of Contents&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#references&#34;&gt;References&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#data-preparation&#34;&gt;Data Preparation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#plot-vertical-line-graph&#34;&gt;Plot vertical line graph&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#flip-the-plot-so-that-horizontal-becomes-vertical-with-coord-flip&#34;&gt;Flip the plot so that horizontal becomes vertical with coord_flip&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-annotation-box-by-geom-rect&#34;&gt;Add annotation box by geom_rect&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#references&#34;&gt;References&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#remove-right-margin-with-expand-c--0-0&#34;&gt;Remove right margin with expand=c(0,0)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#customize-tick-marks-with-limits-and-breaks-of-scale-y-continuous&#34;&gt;customize tick marks with limits and breaks of scale_y_continuous&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-kegg-orthology--ko&#34;&gt;Add KEGG orthology (KO)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/div&gt;
&lt;!--endtoc--&gt;&lt;/p&gt;

&lt;h2 id=&#34;references&#34;&gt;References&lt;/h2&gt;

&lt;p&gt;Kyoto Encyclopedia of Genes and Genomes (KEGG) に関しては以下のサイトを参照&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.genome.jp/kegg/docs/plea.html&#34; target=&#34;_blank&#34;&gt;KEGG&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.kegg.jp/kegg-bin/get%5Fhtext?br08902.keg&#34; target=&#34;_blank&#34;&gt;KEGG BRITE Hierarchy Files&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.genome.jp/kegg-bin/show%5Fpathway?map01100&#34; target=&#34;_blank&#34;&gt;KEGG Metabolic pathways&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.genome.jp/kegg/ko.html&#34; target=&#34;_blank&#34;&gt;KO (KEGG ORTHOLOGY) Database&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;data-preparation&#34;&gt;Data Preparation&lt;/h2&gt;

&lt;p&gt;例によって，まず，架空のデータを作成する．Drugを投与して1，5，12，24時間後の代謝物の血中濃度変化を対照，つまり偽薬を投与した群と比較するという実験の結果を適当に作成する．代謝経路はKEGGのデータベースから適当に名前を充てがっておく．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;set.seed(100)
data.df1 &amp;lt;- data.frame(
  Pathwayname = c(&amp;quot;Cysteine and methionine metabolism&amp;quot;,&amp;quot;Histidine metabolism&amp;quot;,&amp;quot;Glucosinolate biosynthesis&amp;quot;,&amp;quot;Novobiocin biosynthesis&amp;quot;,&amp;quot;Phenylpropanoid biosynthesis&amp;quot;,&amp;quot;Pentose phosphate pathway&amp;quot;,&amp;quot;Cell cycle - yeast&amp;quot;,&amp;quot;Mineral absorption&amp;quot;,&amp;quot;Protein digestion and absorption&amp;quot;,&amp;quot;Type II diabetes mellitus&amp;quot;,&amp;quot;Insulin secretion&amp;quot;,&amp;quot;Carbon fixation in photosynthetic organisms&amp;quot;,&amp;quot;Photosynthesis&amp;quot;,&amp;quot;Peptidoglycan biosynthesis&amp;quot;,&amp;quot;Synthesis and degradation of ketone bodies&amp;quot;,&amp;quot;Cyanoamino acid metabolism&amp;quot;,&amp;quot;D-Glutamine and D-glutamate metabolism&amp;quot;,&amp;quot;Taurine and hypotaurine metabolism&amp;quot;,&amp;quot;GABAergic synapse&amp;quot;,&amp;quot;Retrograde endocannabinoid signaling&amp;quot;,&amp;quot;Synaptic vesicle cycle&amp;quot;,&amp;quot;Pyrimidine metabolism&amp;quot;,&amp;quot;HIF-1 signaling pathway&amp;quot;,&amp;quot;Morphine addiction&amp;quot;,&amp;quot;Nicotine addiction&amp;quot;,&amp;quot;Aminoacyl-tRNA biosynthesis&amp;quot;),
  C = rnorm(26, mean = 0, sd = 0.1),   # C: control
  OneH = rnorm(26, mean = 2, sd = 2),
  FiveH = rnorm(26, mean = 2, sd = 5),
  TwH = rnorm(26, mean = 4, sd = 10),
  TFH = rnorm(26, mean = 5, sd = 20))

data.df1
levels(data.df1$Pathwayname)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;
                                   Pathwayname            C       OneH
1           Cysteine and methionine metabolism -0.050219235  0.5595569
2                         Histidine metabolism  0.013153117  2.4618891
3                   Glucosinolate biosynthesis -0.007891709 -0.3154589
4                      Novobiocin biosynthesis  0.088678481  2.4941520
5                 Phenylpropanoid biosynthesis  0.011697127  1.8177729
6                    Pentose phosphate pathway  0.031863009  5.5147512
7                           Cell cycle - yeast -0.058179068  1.7241408
8                           Mineral absorption  0.071453271  1.7776130
9             Protein digestion and absorption -0.082525943  0.6199714
10                   Type II diabetes mellitus -0.035986213  1.5564115
11                           Insulin secretion  0.008988614  2.3658154
12 Carbon fixation in photosynthetic organisms  0.009627446  2.8346466
13                              Photosynthesis -0.020163395  4.1308047
14                  Peptidoglycan biosynthesis  0.073984050  3.9404040
15  Synthesis and degradation of ketone bodies  0.012337950  1.7967415
16                  Cyanoamino acid metabolism -0.002931671  4.8064070
17      D-Glutamine and D-glutamate metabolism -0.038885425 -1.5535513
18          Taurine and hypotaurine metabolism  0.051085626  3.2457348
19                           GABAergic synapse -0.091381419  0.9554333
20        Retrograde endocannabinoid signaling  0.231029682  4.6444619
21                      Synaptic vesicle cycle -0.043808998  1.2731193
22                       Pyrimidine metabolism  0.076406062  4.6381315
23                     HIF-1 signaling pathway  0.026196129  2.0875581
24                          Morphine addiction  0.077340460 -1.7573118
25                          Nicotine addiction -0.081437912  1.1058756
26                 Aminoacyl-tRNA biosynthesis -0.043845057 -1.4771959
        FiveH         TwH         TFH
1   2.8943242  14.0845187 -24.1598745
2  11.4873285 -16.7440475  -3.0061184
3  -9.3596274  12.9682227 -10.5283457
4   6.9023207   3.5000423  -2.3859302
5  -4.9941281  -9.4534931  29.8020292
6  11.1243621 -15.3121153   2.8513238
7   8.9064936  11.0958158   8.4518701
8  -2.1942594   2.4209497  10.0920254
9   0.6900211   6.1636787  -7.2906766
10  1.6557799  12.1736208 -23.5843019
11  0.1055822  21.2717575  -1.6195087
12 14.9097946   2.9622971   7.5677213
13  2.6491707  -1.5712229  25.3623998
14 -1.5651249  18.2830143  -0.1114738
15  5.1899712  -4.9295740  -1.0508202
16  3.0084580  -7.5757124  37.3038137
17  1.6504153  -1.3029645 -10.4742671
18  1.5375506  28.4568276  13.4800480
19  4.2445164  -4.3249580  -6.6789396
20 -3.3217784   8.1351985  13.3007136
21 -3.8120966  -7.7868314 -25.9052331
22 10.2426087  -7.7403476  -5.3749901
23 -8.3104801   0.6707665  -0.5958311
24  2.0637486  17.6311371  25.1491476
25 -3.4376417  -0.6914734  -4.3913991
26  3.3526975  12.4287563  10.9579408

 [1] &amp;quot;Aminoacyl-tRNA biosynthesis&amp;quot;
 [2] &amp;quot;Carbon fixation in photosynthetic organisms&amp;quot;
 [3] &amp;quot;Cell cycle - yeast&amp;quot;
 [4] &amp;quot;Cyanoamino acid metabolism&amp;quot;
 [5] &amp;quot;Cysteine and methionine metabolism&amp;quot;
 [6] &amp;quot;D-Glutamine and D-glutamate metabolism&amp;quot;
 [7] &amp;quot;GABAergic synapse&amp;quot;
 [8] &amp;quot;Glucosinolate biosynthesis&amp;quot;
 [9] &amp;quot;HIF-1 signaling pathway&amp;quot;
[10] &amp;quot;Histidine metabolism&amp;quot;
[11] &amp;quot;Insulin secretion&amp;quot;
[12] &amp;quot;Mineral absorption&amp;quot;
[13] &amp;quot;Morphine addiction&amp;quot;
[14] &amp;quot;Nicotine addiction&amp;quot;
[15] &amp;quot;Novobiocin biosynthesis&amp;quot;
[16] &amp;quot;Pentose phosphate pathway&amp;quot;
[17] &amp;quot;Peptidoglycan biosynthesis&amp;quot;
[18] &amp;quot;Phenylpropanoid biosynthesis&amp;quot;
[19] &amp;quot;Photosynthesis&amp;quot;
[20] &amp;quot;Protein digestion and absorption&amp;quot;
[21] &amp;quot;Pyrimidine metabolism&amp;quot;
[22] &amp;quot;Retrograde endocannabinoid signaling&amp;quot;
[23] &amp;quot;Synaptic vesicle cycle&amp;quot;
[24] &amp;quot;Synthesis and degradation of ketone bodies&amp;quot;
[25] &amp;quot;Taurine and hypotaurine metabolism&amp;quot;
[26] &amp;quot;Type II diabetes mellitus&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Pathwaynameのlevelsを変更する．KEGG orthologyに合わせた配置にするためである．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;data.df1$Pathwayname &amp;lt;- factor(data.df1$Pathwayname,
                               levels = c(&amp;quot;Aminoacyl-tRNA biosynthesis&amp;quot;, &amp;quot;Nicotine addiction&amp;quot;, &amp;quot;Morphine addiction&amp;quot;, &amp;quot;HIF-1 signaling pathway&amp;quot;, &amp;quot;Pyrimidine metabolism&amp;quot;, &amp;quot;Synaptic vesicle cycle&amp;quot;, &amp;quot;Retrograde endocannabinoid signaling&amp;quot;, &amp;quot;GABAergic synapse&amp;quot;, &amp;quot;Taurine and hypotaurine metabolism&amp;quot;, &amp;quot;D-Glutamine and D-glutamate metabolism&amp;quot;, &amp;quot;Cyanoamino acid metabolism&amp;quot;, &amp;quot;Synthesis and degradation of ketone bodies&amp;quot;, &amp;quot;Peptidoglycan biosynthesis&amp;quot;, &amp;quot;Photosynthesis&amp;quot;, &amp;quot;Carbon fixation in photosynthetic organisms&amp;quot;, &amp;quot;Insulin secretion&amp;quot;, &amp;quot;Type II diabetes mellitus&amp;quot;, &amp;quot;Protein digestion and absorption&amp;quot;, &amp;quot;Mineral absorption&amp;quot;, &amp;quot;Cell cycle - yeast&amp;quot;, &amp;quot;Pentose phosphate pathway&amp;quot;, &amp;quot;Phenylpropanoid biosynthesis&amp;quot;, &amp;quot;Novobiocin biosynthesis&amp;quot;, &amp;quot;Glucosinolate biosynthesis&amp;quot;, &amp;quot;Histidine metabolism&amp;quot;, &amp;quot;Cysteine and methionine metabolism&amp;quot;),
                               labels = c(&amp;quot;Aminoacyl-tRNA biosynthesis&amp;quot;, &amp;quot;Nicotine addiction&amp;quot;, &amp;quot;Morphine addiction&amp;quot;, &amp;quot;HIF-1 signaling pathway&amp;quot;, &amp;quot;Pyrimidine metabolism&amp;quot;, &amp;quot;Synaptic vesicle cycle&amp;quot;, &amp;quot;Retrograde endocannabinoid signaling&amp;quot;, &amp;quot;GABAergic synapse&amp;quot;, &amp;quot;Taurine and hypotaurine metabolism&amp;quot;, &amp;quot;D-Glutamine and D-glutamate metabolism&amp;quot;, &amp;quot;Cyanoamino acid metabolism&amp;quot;, &amp;quot;Synthesis and degradation of ketone bodies&amp;quot;, &amp;quot;Peptidoglycan biosynthesis&amp;quot;, &amp;quot;Photosynthesis&amp;quot;, &amp;quot;Carbon fixation in photosynthetic organisms&amp;quot;, &amp;quot;Insulin secretion&amp;quot;, &amp;quot;Type II diabetes mellitus&amp;quot;, &amp;quot;Protein digestion and absorption&amp;quot;, &amp;quot;Mineral absorption&amp;quot;, &amp;quot;Cell cycle - yeast&amp;quot;, &amp;quot;Pentose phosphate pathway&amp;quot;, &amp;quot;Phenylpropanoid biosynthesis&amp;quot;, &amp;quot;Novobiocin biosynthesis&amp;quot;, &amp;quot;Glucosinolate biosynthesis&amp;quot;, &amp;quot;Histidine metabolism&amp;quot;, &amp;quot;Cysteine and methionine metabolism&amp;quot;))
levels(data.df1$Pathwayname)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;
 [1] &amp;quot;Aminoacyl-tRNA biosynthesis&amp;quot;
 [2] &amp;quot;Nicotine addiction&amp;quot;
 [3] &amp;quot;Morphine addiction&amp;quot;
 [4] &amp;quot;HIF-1 signaling pathway&amp;quot;
 [5] &amp;quot;Pyrimidine metabolism&amp;quot;
 [6] &amp;quot;Synaptic vesicle cycle&amp;quot;
 [7] &amp;quot;Retrograde endocannabinoid signaling&amp;quot;
 [8] &amp;quot;GABAergic synapse&amp;quot;
 [9] &amp;quot;Taurine and hypotaurine metabolism&amp;quot;
[10] &amp;quot;D-Glutamine and D-glutamate metabolism&amp;quot;
[11] &amp;quot;Cyanoamino acid metabolism&amp;quot;
[12] &amp;quot;Synthesis and degradation of ketone bodies&amp;quot;
[13] &amp;quot;Peptidoglycan biosynthesis&amp;quot;
[14] &amp;quot;Photosynthesis&amp;quot;
[15] &amp;quot;Carbon fixation in photosynthetic organisms&amp;quot;
[16] &amp;quot;Insulin secretion&amp;quot;
[17] &amp;quot;Type II diabetes mellitus&amp;quot;
[18] &amp;quot;Protein digestion and absorption&amp;quot;
[19] &amp;quot;Mineral absorption&amp;quot;
[20] &amp;quot;Cell cycle - yeast&amp;quot;
[21] &amp;quot;Pentose phosphate pathway&amp;quot;
[22] &amp;quot;Phenylpropanoid biosynthesis&amp;quot;
[23] &amp;quot;Novobiocin biosynthesis&amp;quot;
[24] &amp;quot;Glucosinolate biosynthesis&amp;quot;
[25] &amp;quot;Histidine metabolism&amp;quot;
[26] &amp;quot;Cysteine and methionine metabolism&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;データの整形を行う．reshapeのmeltでlong formatのデータにする．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(reshape)
data_melt.df1 &amp;lt;- melt(data.df1)
head(data_melt.df1)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;
Using Pathwayname as id variables

                         Pathwayname variable        value
1 Cysteine and methionine metabolism        C -0.050219235
2               Histidine metabolism        C  0.013153117
3         Glucosinolate biosynthesis        C -0.007891709
4            Novobiocin biosynthesis        C  0.088678481
5       Phenylpropanoid biosynthesis        C  0.011697127
6          Pentose phosphate pathway        C  0.031863009
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで解析用のデータが出来上がった．&lt;/p&gt;

&lt;h2 id=&#34;plot-vertical-line-graph&#34;&gt;Plot vertical line graph&lt;/h2&gt;

&lt;p&gt;いきなり，Pathwaynameをy軸に設定すると全てのポイントが連結されたグラフになってしまうので，まず，Pathwaynameをｘ軸に設定して折れ線グラフを描く．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(ggplot2)
LinePlot_H &amp;lt;- ggplot(data_melt.df1, aes(x = Pathwayname, y = value, group = variable)) +
  theme_bw()
LinePlot_H + geom_line(aes(colour = variable))
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/horizontal_lineplot.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/horizontal_lineplot.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h2 id=&#34;flip-the-plot-so-that-horizontal-becomes-vertical-with-coord-flip&#34;&gt;Flip the plot so that horizontal becomes vertical with coord_flip&lt;/h2&gt;

&lt;p&gt;勿論，これではダメなので，coord_flipでｘ軸とｙ軸をひっくり返す．また，色もかえる．さらに，x軸とy軸のタイトルを除き，凡例を中に入れて，そのタイトルを除く．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;LinePlot_V &amp;lt;- ggplot(data_melt.df1, aes(x = Pathwayname, y = value, group = variable)) +
  theme_bw()
P1 &amp;lt;- LinePlot_V +
  geom_line(aes(colour = variable)) +
  scale_color_manual(values = c(&amp;quot;black&amp;quot;, &amp;quot;green&amp;quot;, &amp;quot;orange&amp;quot;, &amp;quot;blue&amp;quot;, &amp;quot;red&amp;quot;)) +
  xlab(&amp;quot;&amp;quot;) +
  ylab(&amp;quot;&amp;quot;) +
  coord_flip()

P1 + theme(legend.position = c(0.9, 0.7)) + theme(legend.title = element_blank())
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/vertical_lineplot.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/vertical_lineplot.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h2 id=&#34;add-annotation-box-by-geom-rect&#34;&gt;Add annotation box by geom_rect&lt;/h2&gt;

&lt;p&gt;とりあえずは，それなりの縦向き折れ線グラフが出来上がった．このグラフに注釈ボックスをつけてみる．試行錯誤の結果，ggplot2の場合，geom_rectを使用すれば良いことがわかった．&lt;/p&gt;

&lt;h3 id=&#34;references-1&#34;&gt;References&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://stackoverflow.com/questions/24536651/what-is-a-good-way-to-fit-text-inside-a-plotting-area-with-ggplot2-using-a-pre-d&#34; target=&#34;_blank&#34;&gt;What is a good way to fit text inside a plotting area with ggplot2 using a pre-defined width for the text?&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://sape.inf.usi.ch/quick-reference/ggplot2/geom%5Frect&#34; target=&#34;_blank&#34;&gt;ggplot2 Quick Reference: geom_rect&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://stackoverflow.com/questions/26741703/adding-multiple-shadows-rectangles-to-ggplot2-graph&#34; target=&#34;_blank&#34;&gt;Adding multiple shadows/rectangles to ggplot2 graph&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;まず，注釈ボックスとするrectangle用のデータを用意する．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;rect1 &amp;lt;- data.frame (xmin=24.55, xmax=26.75, ymin=40, ymax=90, text = data_melt.df1[1,1])
rect2 &amp;lt;- data.frame (xmin=21.55, xmax=24.45, ymin=40, ymax=90, text = data_melt.df1[2,1])
rect3 &amp;lt;- data.frame (xmin=20.55, xmax=21.45, ymin=40, ymax=90, text = data_melt.df1[3,1])
rect4 &amp;lt;- data.frame (xmin=19.55, xmax=20.45, ymin=40, ymax=90, text = data_melt.df1[4,1])
rect5 &amp;lt;- data.frame (xmin=17.55, xmax=19.45, ymin=40, ymax=90, text = data_melt.df1[5,1])
rect6 &amp;lt;- data.frame (xmin=16.55, xmax=17.45, ymin=40, ymax=90, text = data_melt.df1[6,1])
rect7 &amp;lt;- data.frame (xmin=15.55, xmax=16.45, ymin=40, ymax=90, text = data_melt.df1[7,1])
rect8 &amp;lt;- data.frame (xmin=13.55, xmax=15.45, ymin=40, ymax=90, text = data_melt.df1[8,1])
rect9 &amp;lt;- data.frame (xmin=12.55, xmax=13.45, ymin=40, ymax=90, text = data_melt.df1[9,1])
rect10 &amp;lt;- data.frame (xmin=11.55, xmax=12.45, ymin=40, ymax=90, text = data_melt.df1[10,1])
rect11 &amp;lt;- data.frame (xmin=8.55, xmax=11.45, ymin=40, ymax=90, text = data_melt.df1[11,1])
rect12 &amp;lt;- data.frame (xmin=5.55, xmax=8.45, ymin=40, ymax=90, text = data_melt.df1[12,1])
rect13 &amp;lt;- data.frame (xmin=4.55, xmax=5.45, ymin=40, ymax=90, text = data_melt.df1[13,1])
rect14 &amp;lt;- data.frame (xmin=3.55, xmax=4.45, ymin=40, ymax=90, text = data_melt.df1[14,1])
rect15 &amp;lt;- data.frame (xmin=1.55, xmax=3.45, ymin=40, ymax=90, text = data_melt.df1[15,1])
rect16 &amp;lt;- data.frame (xmin=0, xmax=1.45, ymin=40, ymax=90, text = data_melt.df1[16,1])
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;remove-right-margin-with-expand-c--0-0&#34;&gt;Remove right margin with expand=c(0,0)&lt;/h3&gt;

&lt;p&gt;ボックスの右端を90にしたので，グラフがはみ出さないように，scale_y_continuousを用いて，expand=c(0,0)で余白を省き，limitsで軸の範囲を指定する．凡例の位置も変え，背景を透明にして，フォントサイズも小さくする．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;P2 &amp;lt;- P1 + theme(legend.position = c(0.0825, 0.43)) +
  theme(legend.title = element_blank(),
        legend.text =  element_text(size = 6),
        legend.background = element_blank())       # legendの背景を透明にする
P2

P3 &amp;lt;- P2 +
  geom_rect(data=rect1, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect2, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect3, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect4, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect5, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect6, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect7, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect8, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect9, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect10, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect11, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect12, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect13, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect14, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect15, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE) +
  geom_rect(data=rect16, aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax), fill=&amp;quot;grey90&amp;quot;, alpha=1, color=&amp;quot;black&amp;quot;, lwd = 0.25, inherit.aes = FALSE)

P3 + scale_y_continuous(expand=c(0,0), limits = c(-30, 90))
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/vertical_lineplot2.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/vertical_lineplot2.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h3 id=&#34;customize-tick-marks-with-limits-and-breaks-of-scale-y-continuous&#34;&gt;customize tick marks with limits and breaks of scale_y_continuous&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://www.sthda.com/english/wiki/ggplot2-axis-ticks-a-guide-to-customize-tick-marks-and-labels&#34; target=&#34;_blank&#34;&gt;ggplot2 axis ticks : A guide to customize tick marks and labels&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;ticksを指定する．範囲も指定する．scale_y_continuousのlimitsとbreaksは別々に書くとお互いを上書きするので，同じ () の中で書くようにすると両方ともが効くようになる．&lt;br /&gt;
&lt;a href=&#34;https://stackoverflow.com/questions/38313204/r-ggplot2-scale-y-continuous-combining-breaks-limits/38313454#38313454&#34; target=&#34;_blank&#34;&gt;R ggplot2 scale_y_continuous : Combining breaks &amp;amp; limits&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;P4 &amp;lt;- P3 +
  scale_y_continuous(expand=c(0,0), limits = c(-30, 90), breaks=c(-20, 0, 20, 40))
P4
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/vertical_lineplot3.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/vertical_lineplot3.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;これで空白の注釈用ボックスができた．&lt;/p&gt;

&lt;h3 id=&#34;add-kegg-orthology--ko&#34;&gt;Add KEGG orthology (KO)&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://sape.inf.usi.ch/quick-reference/ggplot2/geom%5Frect&#34; target=&#34;_blank&#34;&gt;ggplot2 Quick Reference: geom_rect&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;上記サイトを参考にして，空白のボックスに該当するKOを記入する．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;P4 +
  geom_text(data = rect1, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Amino acid metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect2, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Biosynthesis of \n other secondary metabolites&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect3, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Carbohydrate metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect4, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Cell growth and death&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect5, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Digestive system&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect6, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Endocrine and metabolic disease&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect7, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Endocrine system&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect8, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Energy metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect9, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Glycan biosynthesis and metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect10, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Lipid metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect11, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Metabolism of other amino acids&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect12, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Nervous system&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect13, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Nucleotide metabolism&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect14, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Signal transduction&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect15, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Substance dependence&amp;quot;), inherit.aes = FALSE, size = 2.4) +
  geom_text(data = rect16, aes(x=xmin+(xmax-xmin)/2, y=ymin+(ymax-ymin)/2, label= &amp;quot;Translation&amp;quot;), inherit.aes = FALSE, size = 2.4)
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/vertical_lineplot4.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/vertical_lineplot4.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;ようやく完成である．この方法は他のタイプのグラフにも使えると思う．もっと簡単な方法があれば良いのだが．．．&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>How to add different segment, annotation and color to each facet in ggplot</title>
      <link>/post/different-segment-to-each-facet-in-ggplot/</link>
      <pubDate>Sat, 06 Apr 2019 00:00:00 +0900</pubDate>
      <guid>/post/different-segment-to-each-facet-in-ggplot/</guid>
      <description>

&lt;p&gt;今回もRネタである．論文の図を作成していて，ggplot2のfacetを使用して作成した図の中のfacet毎に異なる有意差を示す群を線分で結んで，その上にasteriskを色を変えてつけようとしたところ，結構苦労したので忘れないうちにまとめておく．annotate()というのもあるが，これだとすべてのfacetに同じ内容が入ってしまう．今回の目的であるfacetによって異なる内容の注釈を入れるためには，geom_segmentやgeom_textを使う．&lt;/p&gt;

&lt;div class=&#34;ox-hugo-toc toc&#34;&gt;
&lt;div&gt;&lt;/div&gt;

&lt;div class=&#34;heading&#34;&gt;Table of Contents&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#references&#34;&gt;References&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#data-preparation&#34;&gt;Data Preparation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#tukey-multiple-comparison&#34;&gt;Tukey multiple comparison&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#tukeyhsd&#34;&gt;TukeyHSD&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#テューキーの方法による多重比較&#34;&gt;テューキーの方法による多重比較&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#boxplot-by-ggplot2&#34;&gt;Boxplot by ggplot2&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#calculate-mean-and-se&#34;&gt;Calculate mean and SE&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#geom-jitter&#34;&gt;geom_jitter&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#geom-point&#34;&gt;geom_point&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-mean-bar&#34;&gt;Add mean bar&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-segment-and-asterisk-to-drug2-facet-of-boxplot&#34;&gt;Add segment and asterisk to Drug2 facet of boxplot&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#dataframe-for-annotation&#34;&gt;Dataframe for annotation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-segment-with-geom-segment-and-asterisk-with-geom-text--black&#34;&gt;Add segment with geom_segment and asterisk with geom_text (black)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-segment-with-geom-segment-and-asterisk-with-geom-text--color&#34;&gt;Add segment with geom_segment and asterisk with geom_text (color)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#barplot-by-ggplot2&#34;&gt;Barplot by ggplot2&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#barplot&#34;&gt;Barplot&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-segment-and-asterisk-to-drug2-facet-of-barplot&#34;&gt;Add segment and asterisk to Drug2 facet of barplot&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#dataframe-for-annotation&#34;&gt;Dataframe for annotation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#add-segment-with-geom-segment-and-asterisk-with-geom-text--color&#34;&gt;Add segment with geom_segment and asterisk with geom_text (color)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#combine-boxplot-and-barplot-into-the-same-graphic&#34;&gt;Combine boxplot and barplot into the same graphic&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/div&gt;
&lt;!--endtoc--&gt;&lt;/p&gt;

&lt;h2 id=&#34;references&#34;&gt;References&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://mukkujohn.hatenablog.com/entry/2016/09/29/212901&#34; target=&#34;_blank&#34;&gt;ggplot2を使って、注釈を入れる-2&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://buzzrbeeline.blog/2018/11/06/adding-different-annotation-to-each-facet-in-ggplot/&#34; target=&#34;_blank&#34;&gt;Adding different annotation to each facet in ggplot&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://stackoverflow.com/questions/24578352/add-a-segment-only-to-one-facet-using-ggplot2&#34; target=&#34;_blank&#34;&gt;Add a segment only to one facet using ggplot2&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;data-preparation&#34;&gt;Data Preparation&lt;/h2&gt;

&lt;p&gt;まず，架空のデータを作成する．Drug1とDrug2を投与して１日後と７日後の物質Xの血中濃度変化を対照，つまり投与前と比較するという実験において，Drug1では差がなく，Drug2では差があるという結果にする．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;set.seed(100)
data.df1 &amp;lt;- data.frame(Control = rnorm(20, mean = 5, sd = 1),
                       Day1 = rnorm(20, mean = 5, sd = 1.5),
                       Day7 = rnorm(20, mean = 5, sd = 2))
library(reshape)
data_melt.df1 &amp;lt;- melt(data.df1)

data.df2 &amp;lt;- data.frame(Control = rnorm(20, mean = 5, sd = 1.8),
                       Day1 = rnorm(20, mean = 10, sd = 5),
                       Day7 = rnorm(20, mean = 20, sd = 7))
data_melt.df2 &amp;lt;- melt(data.df2)

data_melt.df &amp;lt;- cbind.data.frame(data_melt.df1, data_melt.df2$value)
colnames(data_melt.df) &amp;lt;- c(&amp;quot;Day&amp;quot;,&amp;quot;Drug1&amp;quot;,&amp;quot;Drug2&amp;quot;) # chage column name of dataframe
head(data_melt.df)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;Using  as id variables
Using  as id variables
      Day    Drug1    Drug2
1 Control 4.497808 4.528408
2 Control 5.131531 4.876081
3 Control 4.921083 4.318010
4 Control 5.886785 9.647526
5 Control 5.116971 5.233701
6 Control 5.318630 3.716555
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで解析用のデータが出来上がった．一応，差を確認してみる．&lt;/p&gt;

&lt;h2 id=&#34;tukey-multiple-comparison&#34;&gt;Tukey multiple comparison&lt;/h2&gt;

&lt;p&gt;Tukeyの多重比較試験を行う．２つの方法で確認しておく．&lt;/p&gt;

&lt;h3 id=&#34;tukeyhsd&#34;&gt;TukeyHSD&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TukeyHSD(aov(data_melt.df$Drug1~data_melt.df$Day))
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = data_melt.df$Drug1 ~ data_melt.df$Day)

$`data_melt.df$Day`
                    diff       lwr      upr     p adj
Day1-Control  0.03086351 -1.274284 1.336011 0.9982163
Day7-Control -0.14426065 -1.449408 1.160887 0.9617765
Day7-Day1    -0.17512416 -1.480272 1.130023 0.9442066
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TukeyHSD(aov(data_melt.df$Drug2~data_melt.df$Day))
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = data_melt.df$Drug2 ~ data_melt.df$Day)

$`data_melt.df$Day`
                  diff       lwr       upr     p adj
Day1-Control  4.874433  1.128239  8.620628 0.0076229
Day7-Control 15.114597 11.368403 18.860791 0.0000000
Day7-Day1    10.240164  6.493970 13.986358 0.0000000
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;テューキーの方法による多重比較&#34;&gt;&lt;a href=&#34;http://aoki2.si.gunma-u.ac.jp/R/tukey.html&#34; target=&#34;_blank&#34;&gt;テューキーの方法による多重比較&lt;/a&gt;&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;source(&amp;quot;http://aoki2.si.gunma-u.ac.jp/R/src/tukey.R&amp;quot;, encoding=&amp;quot;euc-jp&amp;quot;)
tukey(data_melt.df$Drug1, data_melt.df$Day)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;$result1
        n     Mean Variance
Group1 20 5.107867 0.516335
Group2 20 5.138731 1.188671
Group3 20 4.963606 7.119660

$Tukey
             t         p
1:2 0.05690583 0.9982163
1:3 0.26598637 0.9617765
2:3 0.32289220 0.9442066

$phi
[1] 57

$v
[1] 2.941555
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;tukey(data_melt.df$Drug2, data_melt.df$Day)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;$result1
        n      Mean Variance
Group1 20  4.811422  4.07251
Group2 20  9.685855 32.74563
Group3 20 19.926019 35.88609

$Tukey
           t            p
1:2 3.131158 7.622857e-03
1:3 9.709065 1.156397e-11
2:3 6.577907 4.783876e-08

$phi
[1] 57

$v
[1] 24.23474
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以上で，Drug1では物質Xの濃度はコントロールと差がないこと，Drug2ではコントロール，Day1，Day7の間に有意差が認められることが確認された．そのようにデータを作ったので当たり前である．．．(^^;;;;;&lt;/p&gt;

&lt;h2 id=&#34;boxplot-by-ggplot2&#34;&gt;Boxplot by ggplot2&lt;/h2&gt;

&lt;p&gt;ようやくここから上記のデータを使って，ggplot2でboxplotを描いてみる．まずはmeltを用いてwide formatからlong formatへのデータの整形を行う．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;DataM &amp;lt;- melt(data_melt.df, id = &amp;quot;Day&amp;quot;)
head(DataM)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;      Day variable    value
1 Control    Drug1 4.497808
2 Control    Drug1 5.131531
3 Control    Drug1 4.921083
4 Control    Drug1 5.886785
5 Control    Drug1 5.116971
6 Control    Drug1 5.318630
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;calculate-mean-and-se&#34;&gt;Calculate mean and SE&lt;/h3&gt;

&lt;p&gt;平均とSEも求めておく．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(plyr)
DataM_summary &amp;lt;- ddply(DataM, .(variable, Day), summarise, N = length(value), mean = mean(value), sd = sd(value), se = sd(value)/sqrt(length(value)))
DataM_summary
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;  variable     Day  N      mean        sd        se
1    Drug1 Control 20  5.107867 0.7185645 0.1606759
2    Drug1    Day1 20  5.138731 1.0902617 0.2437899
3    Drug1    Day7 20  4.963606 2.6682692 0.5966431
4    Drug2 Control 20  4.811422 2.0180460 0.4512488
5    Drug2    Day1 20  9.685855 5.7223794 1.2795629
6    Drug2    Day7 20 19.926019 5.9904997 1.3395165
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ついで，ggplot2のggplotでboxplotを描く．個々のデータをgeom_jitter，あるいは，geom_pointを用いて重ねてプロットしておく．どちらの方法でも下記のように同じ図になる．&lt;/p&gt;

&lt;h3 id=&#34;geom-jitter&#34;&gt;geom_jitter&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(ggplot2)
TestBoxPlot &amp;lt;- ggplot(DataM, aes(x = Day, y = value, colour = Day, fill = Day)) +
    geom_boxplot(alpha = 0.40) +
    facet_wrap(~variable, ncol = 3, scales=&amp;quot;fixed&amp;quot;) +
    coord_cartesian(ylim = c(0,38)) +
    theme_bw() +
    theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), strip.text.x = element_text(size =16)) +
    theme(axis.title.x = element_text(size=14), axis.title.y = element_text(size=16), plot.title=element_text(size=0)) +
    xlab(&amp;quot;&amp;quot;) +
    ylab(&amp;quot;Relative value to control&amp;quot;) +
    theme(legend.position = &amp;quot;none&amp;quot;) +   # delete legend
    geom_jitter(shape=16, size=2, position=position_jitter(0.1))  # plot individual point with jittering

TestBoxPlot
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Boxplot1.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Boxplot1.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h3 id=&#34;geom-point&#34;&gt;geom_point&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBoxPlot2 &amp;lt;- ggplot(DataM, aes(x = Day, y = value, colour = Day, fill = Day)) +
    geom_boxplot(alpha = 0.40) +
    facet_wrap(~variable, ncol = 3, scales=&amp;quot;fixed&amp;quot;) +
    coord_cartesian(ylim = c(0,38)) +
    theme_bw() +
    theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), strip.text.x = element_text(size =16)) +
    theme(axis.title.x = element_text(size=14), axis.title.y = element_text(size=16), plot.title=element_text(size=0)) +
    xlab(&amp;quot;&amp;quot;) +
    ylab(&amp;quot;Relative value to control&amp;quot;) +
    theme(legend.position = &amp;quot;none&amp;quot;) +   # delete legend
    geom_point(aes(fill = Day), size = 2, shape = 16, position = position_jitterdodge())  # plot individual point with jittering

TestBoxPlot2
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Boxplot2.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Boxplot2.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h3 id=&#34;add-mean-bar&#34;&gt;Add mean bar&lt;/h3&gt;

&lt;p&gt;&lt;strong&gt;Ref:&lt;/strong&gt; &lt;a href=&#34;https://stackoverflow.com/questions/45617136/combine-ggplot-facet-wrap-with-geom-segment-to-draw-mean-line-in-scatterplot&#34; target=&#34;_blank&#34;&gt;combine ggplot facet_wrap with geom_segment to draw mean line in scatterplot&lt;/a&gt;   &lt;br /&gt;
平均値のバーを書き込む．これはgeom_segmentを使うが，すべてのfacetに書き込むので，単純である．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBoxPlot3 &amp;lt;- TestBoxPlot +
    geom_segment(data = DataM_summary, aes(x=as.numeric(as.factor(Day)) - 0.5,
                                           xend=as.numeric(as.factor(Day)) + 0.5,
                                           yend=mean,
                                           y=mean,
                                           colour=Day,
                                           alpha=0.7),
                 size = 1.5, linetype = 1)

TestBoxPlot3
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Boxplot1mean.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Boxplot1mean.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h2 id=&#34;add-segment-and-asterisk-to-drug2-facet-of-boxplot&#34;&gt;Add segment and asterisk to Drug2 facet of boxplot&lt;/h2&gt;

&lt;h3 id=&#34;dataframe-for-annotation&#34;&gt;Dataframe for annotation&lt;/h3&gt;

&lt;p&gt;ここからが本番である．上記で作成したグラフを見ながら，どこからどこに線を引けばよいのか，どこにasteriskを置けばよいのか大体の見当をつけたうえで，注釈用のデータフレームを別途作成する．これは手作業でやらざるを得ない．できたグラフを見て微調整をしていく．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;anno &amp;lt;- data.frame(
    x=c(0.9, 0.9, 3.1, 1.1, 1.1, 1.9, 2.1, 2.1, 2.9),
    y=c(10.5, 37, 37, 10.5, 26, 26, 23.5, 34, 34),
    xend=c(0.9, 3.1, 3.1, 1.1, 1.9, 1.9, 2.1, 2.9, 2.9),
    yend=c(37, 37, 32.5, 26, 26, 23.5, 34, 34, 32.5),
    variable=&amp;quot;Drug2&amp;quot;,
    xstar = c(1.5, 2, 2.5, NA, NA, NA, NA, NA, NA),
    ystar = c(27, 38, 35, NA, NA, NA, NA, NA, NA),
    lab = c(&amp;quot;**&amp;quot;, &amp;quot;***&amp;quot;, &amp;quot;***&amp;quot;, NA, NA, NA, NA, NA, NA),
    ast.color = c(&amp;quot;red&amp;quot;, &amp;quot;blue&amp;quot;, &amp;quot;green&amp;quot;, NA, NA, NA, NA, NA, NA))

anno
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;    x    y xend yend variable xstar ystar  lab ast.color
1 0.9 10.5  0.9 37.0    Drug2   1.5    27   **       red
2 0.9 37.0  3.1 37.0    Drug2   2.0    38  ***      blue
3 3.1 37.0  3.1 32.5    Drug2   2.5    35  ***     green
4 1.1 10.5  1.1 26.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
5 1.1 26.0  1.9 26.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
6 1.9 26.0  1.9 23.5    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
7 2.1 23.5  2.1 34.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
8 2.1 34.0  2.9 34.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
9 2.9 34.0  2.9 32.5    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;x, y, xend, yendは各線分の始点と終点で，xstar, ystarは注釈，今回はasteriskの位置を示す．labはasteriskそのものを指示し，colorはasteriskの色を指定している．&lt;/p&gt;

&lt;h3 id=&#34;add-segment-with-geom-segment-and-asterisk-with-geom-text--black&#34;&gt;Add segment with geom_segment and asterisk with geom_text (black)&lt;/h3&gt;

&lt;p&gt;geom_segmentで線を引いて，geom_textでasteriskをつける．まずは黒色でやってみる． &lt;strong&gt;inherit.aes=FALSE&lt;/strong&gt; をgeom_text()とgeom_segment()の内部に追加してggplot()内のfill=Dayを無視させる．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBoxPlot3 +
    geom_text(data = anno, aes(x = xstar, y = ystar, label = lab, colour = NULL), size = 7, family = &amp;quot;Times New Roman&amp;quot;, inherit.aes = FALSE) +
    geom_segment(data = anno, aes(x = x,  y = y, xend=xend, yend=yend), inherit.aes = FALSE)
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Boxplot1mean_anno.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Boxplot1mean_anno.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h3 id=&#34;add-segment-with-geom-segment-and-asterisk-with-geom-text--color&#34;&gt;Add segment with geom_segment and asterisk with geom_text (color)&lt;/h3&gt;

&lt;p&gt;asteriskに色をつける．データフレーム annoに書き込んだ色データを明示的に指示して利用する．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBoxPlot3 +
    geom_text(data = anno, aes(x = xstar, y = ystar, label = lab), colour = anno$ast.color, size = 7, family = &amp;quot;Times New Roman&amp;quot;, inherit.aes = FALSE) +
    geom_segment(data = anno, aes(x = x,  y = y, xend=xend, yend=yend), inherit.aes = FALSE)
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Boxplot1mean_anno_color.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Boxplot1mean_anno_color.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;問題はここである．どうしても， &lt;strong&gt;colour = anno$ast.color&lt;/strong&gt; とデータフレームと変数を明示的に指示しないと色がおかしくなるか，エラーになってしまう．もっとうまくggplotにデータを読ませる方法をどなたかご教示いただければ幸甚である．&lt;/p&gt;

&lt;h2 id=&#34;barplot-by-ggplot2&#34;&gt;Barplot by ggplot2&lt;/h2&gt;

&lt;p&gt;次にbarplotを描いて同じことをやってみる．エラーバーは慣例通りSEにする．&lt;/p&gt;

&lt;h3 id=&#34;barplot&#34;&gt;Barplot&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBarPlot &amp;lt;- ggplot(DataM_summary, aes(x = Day, y = mean, colour = Day, fill=Day)) +
    geom_errorbar(aes(ymin = mean, ymax = mean + se), width = 0.2) +
    geom_bar(position=position_dodge(), stat=&amp;quot;identity&amp;quot;, alpha=1/2, width=0.5) +
    facet_wrap(~variable, scales = &amp;quot;fixed&amp;quot;, ncol=3) +
    coord_cartesian(ylim = c(0,30)) +
    theme_bw() +
    theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), strip.text.x = element_text(size =16)) +
    theme(axis.title.x = element_text(size=14), axis.title.y = element_text(size=16), plot.title=element_text(size=0)) +
    xlab(&amp;quot;&amp;quot;) +
    ylab(&amp;quot;Relative value to control&amp;quot;) +
    theme(legend.position = &amp;quot;none&amp;quot;)   # delete legend

TestBarPlot
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Barplot1.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Barplot1.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h2 id=&#34;add-segment-and-asterisk-to-drug2-facet-of-barplot&#34;&gt;Add segment and asterisk to Drug2 facet of barplot&lt;/h2&gt;

&lt;h3 id=&#34;dataframe-for-annotation-1&#34;&gt;Dataframe for annotation&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;anno2 &amp;lt;- data.frame(
    x=c(0.9, 0.9, 3.1, 1.1, 1.1, 1.9, 2.1, 2.1, 2.9),
    y=c(6.5, 29, 29, 6.5, 17, 17, 12.5, 25, 25),
    xend=c(0.9, 3.1, 3.1, 1.1, 1.9, 1.9, 2.1, 2.9, 2.9),
    yend=c(29, 29, 22.5, 17, 17, 12.5, 25, 25, 22.5),
    variable=&amp;quot;Drug2&amp;quot;,
    xstar = c(1.5, 2, 2.5, NA, NA, NA, NA, NA, NA),
    ystar = c(17.5, 29.5, 25.5, NA, NA, NA, NA, NA, NA),
    lab = c(&amp;quot;**&amp;quot;, &amp;quot;***&amp;quot;, &amp;quot;***&amp;quot;, NA, NA, NA, NA, NA, NA),
    ast.color = c(&amp;quot;red&amp;quot;, &amp;quot;blue&amp;quot;, &amp;quot;green&amp;quot;, NA, NA, NA, NA, NA, NA))

anno2
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;    x    y xend yend variable xstar ystar  lab ast.color
1 0.9  6.5  0.9 29.0    Drug2   1.5  17.5   **       red
2 0.9 29.0  3.1 29.0    Drug2   2.0  29.5  ***      blue
3 3.1 29.0  3.1 22.5    Drug2   2.5  25.5  ***     green
4 1.1  6.5  1.1 17.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
5 1.1 17.0  1.9 17.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
6 1.9 17.0  1.9 12.5    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
7 2.1 12.5  2.1 25.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
8 2.1 25.0  2.9 25.0    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
9 2.9 25.0  2.9 22.5    Drug2    NA    NA &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;add-segment-with-geom-segment-and-asterisk-with-geom-text--color-1&#34;&gt;Add segment with geom_segment and asterisk with geom_text (color)&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;TestBarPlot +
    geom_text(data = anno2, aes(x = xstar, y = ystar, label = lab), colour = anno$ast.color, size = 7, family = &amp;quot;Times New Roman&amp;quot;, inherit.aes = FALSE) +
    geom_segment(data = anno2, aes(x = x,  y = y, xend=xend, yend=yend), inherit.aes = FALSE)
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Barplot1_anno_color.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Barplot1_anno_color.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;barplotでも全く同様のグラフを作成することができた．&lt;/p&gt;

&lt;p&gt;なお，通常のグラフをpdfで出力して，それをOmniGraffleなどのお絵かきソフトに持っていき，手作業で線やasteriskを描いて，再びpdfで出力する，という荒業も使えないことはない．しかし，ggplotの中で完結できるので，余分で面倒な手作業が不要になった．まぁ，上記の作業も面倒ではあるが，再現性があり，他の人にも渡せるというところが重要であると思う．&lt;/p&gt;

&lt;h2 id=&#34;combine-boxplot-and-barplot-into-the-same-graphic&#34;&gt;Combine boxplot and barplot into the same graphic&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Ref1:&lt;/strong&gt; &lt;a href=&#34;https://github.com/thomasp85/patchwork&#34; target=&#34;_blank&#34;&gt;patchwork&lt;/a&gt;   &lt;br /&gt;
&lt;strong&gt;Ref2:&lt;/strong&gt; &lt;a href=&#34;https://qiita.com/nozma/items/4512623bea296ccb74ba&#34; target=&#34;_blank&#34;&gt;patchworkを使って複数のggplotを組み合わせる&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;patchworkを使えば，上記の２種のグラフを簡単に一つの図にできる．比較しやすいようにbarplotのy軸のスケールをboxplotと同じに修正しておく．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;# Boxplot
P1 &amp;lt;- TestBoxPlot3 +
    geom_text(data = anno, aes(x = xstar, y = ystar, label = lab), colour = anno$ast.color, size = 7, family = &amp;quot;Times New Roman&amp;quot;, inherit.aes = FALSE) +
    geom_segment(data = anno, aes(x = x,  y = y, xend=xend, yend=yend), inherit.aes = FALSE)

# Barplot
TestBarPlot2 &amp;lt;- ggplot(DataM_summary, aes(x = Day, y = mean, colour = Day, fill=Day)) +
    geom_errorbar(aes(ymin = mean, ymax = mean + se), width = 0.2) +
    geom_bar(position=position_dodge(), stat=&amp;quot;identity&amp;quot;, alpha=1/2, width=0.5) +
    facet_wrap(~variable, scales = &amp;quot;fixed&amp;quot;, ncol=3) +
    coord_cartesian(ylim = c(0,38)) +
    theme_bw() +
    theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), strip.text.x = element_text(size =16)) +
    theme(axis.title.x = element_text(size=14), axis.title.y = element_text(size=16), plot.title=element_text(size=0)) +
    xlab(&amp;quot;&amp;quot;) +
    ylab(&amp;quot;Relative value to control&amp;quot;) +
    theme(legend.position = &amp;quot;none&amp;quot;)   # delete legend
P2 &amp;lt;- TestBarPlot2 +
    geom_text(data = anno2, aes(x = xstar, y = ystar, label = lab), colour = anno$ast.color, size = 7, family = &amp;quot;Times New Roman&amp;quot;, inherit.aes = FALSE) +
    geom_segment(data = anno2, aes(x = x,  y = y, xend=xend, yend=yend), inherit.aes = FALSE)

library(patchwork)
P1 + P2
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/Combined.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/Combined.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;このpatchworkは足し算だけで２つの図の合体ができてしまうすぐれもの．ちゃんと位置合わせなども自動的にしてくれる．素晴らしい．&lt;/p&gt;

&lt;p&gt;しかし，こうして並べて比べてみると，barplotが如何に情報量の少ないグラフであるかが一目瞭然である．&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>How to automatically embed R plot in blog created by Hugo via ox-hugo</title>
      <link>/post/embedrplotinblog/</link>
      <pubDate>Mon, 25 Mar 2019 00:00:00 +0900</pubDate>
      <guid>/post/embedrplotinblog/</guid>
      <description>

&lt;p&gt;（承前）前回（&lt;a href=&#34;../ExportRplot&#34;&gt;How to automatically embed R plot into html exported by org-mode with org-babel&lt;/a&gt;）はorg-babelを設定して，Rで描いたグラフを自動でhtmlやpdfに挿入するところまでまとめた．繰り返しになるが，本サイトは，ox-hugoで書いてHugo用のMarkdownをexportすることにより作成している．前々回の記事（&lt;a href=&#34;../prodlim&#34;&gt;How to plot survival curve of competing risk analysis with censoring mark and number at risk (at risk table)&lt;/a&gt;）を書いている際に，Rでplotしたgraphをブログ記事の中に自動ではめ込むよう設定するのに苦労した．前回でorg-babelの設定は終わっているので，今回は，Hugoやox-hugoの設定に関してまとめ，ブログ記事へのR plotの自動挿入ができるようにする．&lt;/p&gt;

&lt;div class=&#34;ox-hugo-toc toc&#34;&gt;
&lt;div&gt;&lt;/div&gt;

&lt;div class=&#34;heading&#34;&gt;Table of Contents&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#references&#34;&gt;References&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#configuration-of-hugo-section&#34;&gt;Configuration of Hugo section&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#setup-of-hugo-section-and-hugo-base-dir-in-ox-hugo&#34;&gt;Setup of HUGO_SECTION &amp;amp; HUGO_BASE_DIR in ox-hugo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#references-to-files-outside-the-static-directory&#34;&gt;References to files outside the static directory&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/div&gt;
&lt;!--endtoc--&gt;&lt;/p&gt;

&lt;h2 id=&#34;references&#34;&gt;References&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://gohugo.io&#34; target=&#34;_blank&#34;&gt;HUGO&lt;/a&gt;  &lt;br /&gt;
Hugo is one of the most popular open-source static site generators. With its amazing speed and flexibility, Hugo makes building websites fun again. Hugoのsetupについてはネットに山のように情報があるので，そちらを参照（手抜き）(^^;;;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;&lt;a href=&#34;https://ox-hugo.scripter.co&#34; target=&#34;_blank&#34;&gt;ox-hugo&lt;/a&gt;  &lt;br /&gt;
ox-hugo is an Org exporter backend that exports Org to Hugo-compatible Markdown (Blackfriday) and also generates the front-matter (in TOML or YAML format).&lt;/p&gt;

&lt;p&gt;要するに，Markdownを直接書くのではなく，org-modeで書いてしまおうというもので，私のようなorg-mode maniacにピッタリのパッケージである．ox-hugoのsetupについてもネットに山のように情報があるので，そちらを参照（手抜き）(^^;;;&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;configuration-of-hugo-section&#34;&gt;Configuration of Hugo section&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Ref:&lt;/strong&gt; &lt;a href=&#34;https://sfus.net/blog/2018/12/org-mode-with-ox-hugo/&#34; target=&#34;_blank&#34;&gt;Org-mode で記事を書いて Hugo 向け markdown を ox-hugo で自動生成する話&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;そもそも，まず，Hugoのディレクトリ・ファイルの構成を把握する必要があった．本サイトは，/hogehoge/hogeblog/hogefugablog/hogefugablog.org に書き込んでおり，directory/file構成は以下の通りである．上記参考サイトと同じく，/hogehoge/hogeblog/hogefugablog/，つまり，Hugo の content/ と同じ階層に hogefugablog.org ファイルを置いている．なお，themeは &lt;a href=&#34;https://themes.gohugo.io/academic/&#34; target=&#34;_blank&#34;&gt;&lt;strong&gt;academic&lt;/strong&gt;&lt;/a&gt; を使用している．また，ox-hugoのdirectoryは今回の作業により新たに作成されたものであり，当初はなかった．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ tree -L 2
.
├── config.toml
├── content
│   ├── home
│   ├── post
│   └── privacy.md
├── data
│   └── 6F
├── hogefugablog.org
├── layouts
│   ├── js
│   ├── partials
│   └── search
├── static
│   ├── css
│   ├── files
│   ├── img
│   └── ox-hugo
└── themes
    └── academic
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;setup-of-hugo-section-and-hugo-base-dir-in-ox-hugo&#34;&gt;Setup of HUGO_SECTION &amp;amp; HUGO_BASE_DIR in ox-hugo&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Ref:&lt;/strong&gt; &lt;a href=&#34;https://ox-hugo.scripter.co/doc/usage/#before-you-export&#34; target=&#34;_blank&#34;&gt;Before you export&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;本サイトでは，HUGO_SECTIONは特に設定しておらず，C-h v org-hugo-default-section-directoryの値は default valueであるpostsになっている．&lt;/p&gt;

&lt;p&gt;また，hogefugablog.orgの文頭に以下のように記述して，HUGO_BASE_DIRを設定している．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;#+HUGO_BASE_DIR: ./
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここまでで，ox-hugoからのexportの準備が整った．&lt;/p&gt;

&lt;h2 id=&#34;references-to-files-outside-the-static-directory&#34;&gt;References to files outside the static directory&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;Ref:&lt;/strong&gt; &lt;a href=&#34;https://ox-hugo.scripter.co/doc/image-links/#references-to-files-outside-the-static-directory&#34; target=&#34;_blank&#34;&gt;References to files outside the static directory&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Hugoのstatic directory以外の場所にあるファイルへのreferenceを作成し，かつ，そのファイルが &lt;strong&gt;org-hugo-external-file-extensions-allowed-for-copying&lt;/strong&gt; のリストに挙げられている拡張子を有している場合は，そのファイルはox-hugoによりstatic directoryにコピーされる．ちなみに，C-h v org-hugo-external-file-extensions-allowed-for-copyingとすると，以下のような値を得る．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;org-hugo-external-file-extensions-allowed-for-copying is a variable defined in ‘ox-hugo.el’.
Its value is
(&amp;quot;jpg&amp;quot; &amp;quot;jpeg&amp;quot; &amp;quot;tiff&amp;quot; &amp;quot;png&amp;quot; &amp;quot;svg&amp;quot; &amp;quot;gif&amp;quot; &amp;quot;pdf&amp;quot; &amp;quot;odt&amp;quot; &amp;quot;doc&amp;quot; &amp;quot;ppt&amp;quot; &amp;quot;xls&amp;quot; &amp;quot;docx&amp;quot; &amp;quot;pptx&amp;quot; &amp;quot;xlsx&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;https://ox-hugo.scripter.co/doc/image-links/#source-path-does-not-contain-static&#34; target=&#34;_blank&#34;&gt;Source path does not contain &lt;code&gt;/static/&lt;/code&gt;&lt;/a&gt;    &lt;br /&gt;
このサイトの &lt;strong&gt;Table 2: Where files get copied to if their path does not contain static/&lt;/strong&gt; が本サイトに当てはまる．これが分かるまでに時間を要した．本サイトは，/hogehoge/hogeblog/hogefugablog/hogefugablog.orgに書き込んでいる．この環境で，postの中にorg-babelを使ってRのcode blockを評価すると，Rにより作成されるplot（foo.png）は，&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;/hogehoge/hogeblog/hogefugablog/foo.png
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;に作成される．そして，このファイルは，最終的に，&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;/hogehoge/hogeblog/hogefugablog/static/ox-hugo/foo.png
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;にコピーされ，ブログ記事に挿入されるということになる．なお，ox-hugo directoryはこの時に自動的に作成される．&lt;/p&gt;

&lt;p&gt;つまり，前回の記事（&lt;a href=&#34;../ExportRplot&#34;&gt;How to automatically embed R plot into html exported by org-mode with org-babel&lt;/a&gt;）のように，R plotのcode blockを含むorg ファイルを作成し，それをexportして，R plotが自動で組み込まれるようなら，そのorg-babelのcode blockをそのままox-hugoで書いたブログ記事のorg ファイルにコピペすれば，あとはox-hugoが良きにはからってくれるはずである．&lt;/p&gt;

&lt;p&gt;実は，できたグラフの画像を自分でいろいろな場所にコピーしては失敗していた．Hugoのroot directory，つまり，/hogehoge/hogeblog/hogefugablog/でRを動かして，できたグラフ画像に対して何もせずに放置しておけば，ox-hugoが全て面倒を見てくれるということに気がつかず，余計なことをしていたわけである．&lt;/p&gt;

&lt;p&gt;まとめとして，前回記事のcode blockをこの記事に挿入して試してみる．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;#+begin_src R :session *R* :results output graphics :file test1.png :exports both
boxplot(islands)
#+end_src
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/test1.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/test1.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;#+begin_src R :session *R* :results output graphics :file test2.png :exports both
library(&amp;quot;ggplot2&amp;quot;)
ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length, color = Species)) +
geom_point()
#+END_SRC
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/test2.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/test2.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;ちゃんとグラフが自動的に挿入されている．&lt;/p&gt;

&lt;p&gt;org-babelとRの組み合わせは強力で，ox-hugoも便利と改めて痛感．&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>How to automatically embed R plot into html exported by org-mode with org-babel</title>
      <link>/post/exportrplot/</link>
      <pubDate>Mon, 25 Mar 2019 00:00:00 +0900</pubDate>
      <guid>/post/exportrplot/</guid>
      <description>

&lt;p&gt;本サイトは，ox-hugoで書いてHugo用のMarkdownをexportすることにより作成しているが，前回の記事（&lt;a href=&#34;../prodlim&#34;&gt;How to plot survival curve of competing risk analysis with censoring mark and number at risk (at risk table)&lt;/a&gt;）を書いている際に，Rでplotしたgraphを記事の中に自動ではめ込むよう設定するのに苦労したので，これも忘れないうちにまとめておく．まず，今回はorg-babelの設定について書き，次回にHugoでの設定をまとめる．&lt;/p&gt;

&lt;div class=&#34;ox-hugo-toc toc&#34;&gt;
&lt;div&gt;&lt;/div&gt;

&lt;div class=&#34;heading&#34;&gt;Table of Contents&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#org-babel-setup&#34;&gt;Org-babel setup&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#how-to-use-org-babel&#34;&gt;How to use org-babel&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#org-babel-evaluation-of-r-code-block&#34;&gt;Org-babel evaluation of R code block&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/div&gt;
&lt;!--endtoc--&gt;&lt;/p&gt;

&lt;h2 id=&#34;org-babel-setup&#34;&gt;Org-babel setup&lt;/h2&gt;

&lt;p&gt;org-babelとは，う～～～ん，なにもの？　ものすごく端折って言うと，Code blockを評価して結果を表示するorg-modeの拡張，といったところだろうか．．．実例を見たほうが早いと思う．今回，org-babelによる R code の評価について書こうとして，ふと，ブログを見直してみると，なんとorg-babelの設定をまとめた記事を投稿してない &amp;hellip;..(^^;;;&lt;/p&gt;

&lt;p&gt;ということで，org-babelの設定を改めて記しておく．例によって，init.orgに以下のように書き込んでおけばよい．&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Ref:&lt;/strong&gt; &lt;a href=&#34;http://doc.norang.ca/org-mode.html#OrgBabel&#34; target=&#34;_blank&#34;&gt;Org-babel Setup&lt;/a&gt;　ここからコピペ  (^^;;;&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;#+begin_src emacs-lisp
(org-babel-do-load-languages
 (quote org-babel-load-languages)
 (quote ((emacs-lisp . t)
         (dot . t)
         (ditaa . t)
         (R . t)
         (python . t)
         (ruby . t)
         (gnuplot . t)
         (clojure . t)
         (shell . t)
         (ledger . t)
         (org . t)
         (plantuml . t)
         (latex . t))))
#+end_src
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;how-to-use-org-babel&#34;&gt;How to use org-babel&lt;/h2&gt;

&lt;p&gt;以下のサイトを参考にした．&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Ref 1:&lt;/strong&gt; Official manual &lt;a href=&#34;https://orgmode.org/manual/Working-with-Source-Code.html#Working-with-Source-Code&#34; target=&#34;_blank&#34;&gt;14 Working with Source Code&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Ref 2:&lt;/strong&gt; &lt;a href=&#34;http://misohena.jp/blog/2017-10-26-how-to-use-code-block-of-emacs-org-mode.html&#34; target=&#34;_blank&#34;&gt;org-modeのコードブロック(Babel)の使い方&lt;/a&gt;   &lt;br /&gt;
このサイトが分かりやすい．特に， &lt;strong&gt;ヘッダー引数&lt;/strong&gt; と &lt;strong&gt;言語毎の書き方&lt;/strong&gt; の &lt;strong&gt;R&lt;/strong&gt; の項は必読．&lt;/p&gt;

&lt;h2 id=&#34;org-babel-evaluation-of-r-code-block&#34;&gt;Org-babel evaluation of R code block&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://blogs.neuwirth.priv.at/software/2012/03/28/r-and-emacs-with-org-mode/&#34; target=&#34;_blank&#34;&gt;R and Emacs with org mode&lt;/a&gt;   &lt;br /&gt;
org-babelによるR codeの評価とhtmlへのgraph plotの自動埋め込みは，このサイトが分かりやすい．ここに有る”Using org mode with R”というサンプルを参考に，以下のようなorgファイルを/Data/hogehoge/hogefugaに作成する．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-lisp&#34;&gt;#+TITLE: R-test
#+AUTHOR: taipapa

* Test

  #+begin_src R :session *R* :results output graphics :file test1.png :exports both
  boxplot(islands)
  #+end_src

  #+begin_src R :session *R* :results output graphics :file test2.png :exports both
  library(&amp;quot;ggplot2&amp;quot;)
  ggplot(iris, aes(x = Sepal.Width, y = Sepal.Length, color = Species)) +
  geom_point()
  #+END_SRC
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;C-c C-e h oとしてhtmlにexportすると，以下のように簡単にグラフがプロットされたhtmlが作成される．いちいちできたグラフ画像を挿入する必要はなく，自動で挿入される．便利である．&lt;/p&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/img/R-test-html.png&#34; &gt;

&lt;img src=&#34;/img/R-test-html.png&#34; width=&#34;100%&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;　　注意点としては，C-c C-e hoとしたときに， &lt;strong&gt;R starting project directory？&lt;/strong&gt; と尋ねられるはずで，defaultの値として　/Data/hogehoge/hogefuga/ が既に表示されているはずである．これをそのままリターンすれば同じdirectoryにグラフが作成されて良きにはからってくれる．この際に異なるdirectoryを選んだりするとうまくいかないので注意．&lt;/p&gt;

&lt;p&gt;また，C-c C-e loとすると，自動でR plotの挿入されたpdfが作成されオープンする．&lt;/p&gt;

&lt;p&gt;これで準備が整った．次回はHugoで作成したブログにR plotを自動で差し込む方法をまとめる予定である．&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>How to plot survival curve of competing risk analysis with censoring mark and number at risk (at risk table)</title>
      <link>/post/prodlim/</link>
      <pubDate>Wed, 20 Mar 2019 00:00:00 +0900</pubDate>
      <guid>/post/prodlim/</guid>
      <description>

&lt;p&gt;Rを用いて生存分析を行う際に， &lt;strong&gt;Kaplan-Meier curve&lt;/strong&gt; に打ち切りのマークを入れたり，number at risk (at risk table)を併記する方法はすぐに見つかるが（&lt;a href=&#34;http://rstudio-pubs-static.s3.amazonaws.com/5588%5F72eb65bfbe0a4cb7b655d2eee0751584.html&#34; target=&#34;_blank&#34;&gt;Drawing survival curves in R&lt;/a&gt;, &lt;a href=&#34;https://github.com/michaelway/ggkm&#34; target=&#34;_blank&#34;&gt;ggkm&lt;/a&gt;, &lt;a href=&#34;https://cran.r-project.org/web/packages/survminer/vignettes/Informative%5FSurvival%5FPlots.html&#34; target=&#34;_blank&#34;&gt;Survival plots have never been so informative&lt;/a&gt;），competing riskのplotの場合はあまり情報がない．prodlimを使えば簡単なので，まとめておく．&lt;/p&gt;

&lt;p&gt;なお， &lt;strong&gt;competing risk&lt;/strong&gt; については以下を参照．&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.nature.com/articles/1705727&#34; target=&#34;_blank&#34;&gt;Competing risk analysis using R: an easy guide for clinicians&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.nature.com/articles/bmt2009359&#34; target=&#34;_blank&#34;&gt;Regression modeling of competing risk using R: an in depth guide for clinicians&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://rstudio-pubs-static.s3.amazonaws.com/6600%5Fe6703101eb7441ccb792000f4193b3b9.html&#34; target=&#34;_blank&#34;&gt;Competing risk analysisのデモ&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://rpubs.com/alecri/258589&#34; target=&#34;_blank&#34;&gt;A not so short review on survival analysis in R&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&#34;ox-hugo-toc toc&#34;&gt;
&lt;div&gt;&lt;/div&gt;

&lt;div class=&#34;heading&#34;&gt;Table of Contents&lt;/div&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#prepare-dataset-melanoma-from-riskregression-package&#34;&gt;Prepare dataset &amp;ldquo;Melanoma&amp;rdquo; from &amp;ldquo;riskRegression&amp;rdquo; package&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#competing-risk-analysis-with-cuminc-of-cmprsk-package&#34;&gt;Competing risk analysis with cuminc of &amp;ldquo;cmprsk&amp;rdquo; package&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#competing-risk-analysis-with-prodlim&#34;&gt;Competing risk analysis with prodlim&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;#days&#34;&gt;Days&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#years&#34;&gt;Years&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#plot-survival-curve-of-competing-risk-analysis-with-prodlim--default&#34;&gt;Plot survival curve of competing risk analysis with prodlim (default)&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;#plot-survival-curve-of-competing-risk-analysis-with-prodlim--modified&#34;&gt;Plot survival curve of competing risk analysis with prodlim (modified)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;/div&gt;
&lt;!--endtoc--&gt;&lt;/p&gt;

&lt;h2 id=&#34;prepare-dataset-melanoma-from-riskregression-package&#34;&gt;Prepare dataset &amp;ldquo;Melanoma&amp;rdquo; from &amp;ldquo;riskRegression&amp;rdquo; package&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(riskRegression)
data(Melanoma)
head(Melanoma)
summary(Melanoma)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;  time status                    event invasion ici      epicel       ulcer
1   10      2       death.other.causes  level.1   2     present     present
2   30      2       death.other.causes  level.0   0 not present not present
3   35      0                 censored  level.1   2 not present not present
4   99      2       death.other.causes  level.0   2 not present not present
5  185      1 death.malignant.melanoma  level.2   2     present     present
6  204      1 death.malignant.melanoma  level.2   2 not present     present
  thick    sex age   logthick
1  6.76   Male  76  1.9110229
2  0.65   Male  56 -0.4307829
3  1.34   Male  41  0.2926696
4  2.90 Female  71  1.0647107
5 12.08   Male  52  2.4915512
6  4.84   Male  28  1.5769147
      time          status                            event        invasion
 Min.   :  10   Min.   :0.0000   censored                :134   level.0:99
 1st Qu.:1525   1st Qu.:0.0000   death.malignant.melanoma: 57   level.1:77
 Median :2005   Median :0.0000   death.other.causes      : 14   level.2:29
 Mean   :2153   Mean   :0.4146
 3rd Qu.:3042   3rd Qu.:1.0000
 Max.   :5565   Max.   :2.0000
 ici             epicel            ulcer         thick           sex
 0: 17   not present:116   not present:115   Min.   : 0.10   Female:126
 1: 59   present    : 89   present    : 90   1st Qu.: 0.97   Male  : 79
 2:107                                       Median : 1.94
 3: 22                                       Mean   : 2.92
                                             3rd Qu.: 3.56
                                             Max.   :17.42
      age           logthick
 Min.   : 4.00   Min.   :-2.30259
 1st Qu.:42.00   1st Qu.:-0.03046
 Median :54.00   Median : 0.66269
 Mean   :52.46   Mean   : 0.61817
 3rd Qu.:65.00   3rd Qu.: 1.26976
 Max.   :95.00   Max.   : 2.85762
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;competing-risk-analysis-with-cuminc-of-cmprsk-package&#34;&gt;Competing risk analysis with cuminc of &amp;ldquo;cmprsk&amp;rdquo; package&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;cuminc is used to investigate whether a statistically significant difference is present between the groups (see &amp;ldquo;Tests:&amp;rdquo; below).&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;library(cmprsk)
Results_cmprsk &amp;lt;- with(Melanoma, cuminc(time, event, group = sex, cencode = &amp;quot;censored&amp;quot;))
Results_cmprsk
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;Tests:
                          stat        pv df
death.malignant.melanoma 5.8140209 0.0158989  1
death.other.causes       0.8543656 0.3553203  1
Estimates and Variances:
$est
                                  1000       2000       3000       4000
Female death.malignant.melanoma 0.08730159 0.18077594 0.23565169 0.28424490
Male death.malignant.melanoma   0.19237175 0.31009828 0.42453587 0.42453587
Female death.other.causes       0.03174603 0.03983516 0.05220642 0.08538385
Male death.other.causes         0.03814124 0.06693942 0.06693942 0.13474271
                                  5000
Female death.malignant.melanoma 0.28424490
Male death.malignant.melanoma           NA
Female death.other.causes       0.08538385
Male death.other.causes                 NA

$var
                                    1000         2000         3000
Female death.malignant.melanoma 0.0006378135 0.0012450462 0.0018102025
Male death.malignant.melanoma   0.0020223293 0.0028196248 0.0042695603
Female death.other.causes       0.0002459647 0.0003073878 0.0004529114
Male death.other.causes         0.0004727379 0.0008614343 0.0008614343
                                   4000        5000
Female death.malignant.melanoma 0.002755577 0.002755577
Male death.malignant.melanoma   0.004269560          NA
Female death.other.causes       0.001528480 0.001528480
Male death.other.causes         0.002950698          NA
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;competing-risk-analysis-with-prodlim&#34;&gt;Competing risk analysis with prodlim&lt;/h2&gt;

&lt;h3 id=&#34;days&#34;&gt;Days&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;CompRskAnalysis &amp;lt;- prodlim(Hist(time, status, cens.code=0) ~ sex, data = Melanoma)
summary(CompRskAnalysis)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;

----------&amp;gt; Cause:  1

sex=Female :
  time n.risk n.event n.lost cuminc se.cuminc  lower upper
1   10    126       0      0  0.000    0.0000 0.0000 0.000
2 1513    104       0      0  0.127    0.0297 0.0688 0.185
3 2006     67       0      0  0.181    0.0351 0.1120 0.250
4 3042     34       0      0  0.236    0.0423 0.1528 0.318
5 5565      1       0      1  0.284    0.0519 0.1826 0.386

sex=Male :
  time n.risk n.event n.lost cuminc se.cuminc lower upper
1   10     79       0      0  0.000    0.0000 0.000 0.000
2 1513     51       0      0  0.270    0.0503 0.171 0.368
3 2006     35       0      0  0.310    0.0527 0.207 0.413
4 3042     18       0      0  0.425    0.0644 0.298 0.551
5 5565      0       0      0     NA        NA    NA    NA



----------&amp;gt; Cause:  2

sex=Female :
  time n.risk n.event n.lost cuminc se.cuminc   lower  upper
1   10    126       0      0 0.0000    0.0000 0.00000 0.0000
2 1513    104       0      0 0.0317    0.0156 0.00113 0.0624
3 2006     67       0      0 0.0398    0.0175 0.00562 0.0741
4 3042     34       0      0 0.0522    0.0212 0.01073 0.0937
5 5565      1       0      1 0.0854    0.0383 0.01027 0.1605

sex=Male :
  time n.risk n.event n.lost cuminc se.cuminc   lower  upper
1   10     79       1      0 0.0127    0.0126 0.00000 0.0373
2 1513     51       0      0 0.0510    0.0248 0.00230 0.0996
3 2006     35       0      0 0.0669    0.0291 0.00992 0.1240
4 3042     18       0      0 0.0669    0.0291 0.00992 0.1240
5 5565      0       0      0     NA        NA      NA     NA
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;years&#34;&gt;Years&lt;/h3&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;CompRskAnalysis2 &amp;lt;- prodlim(Hist(time/365.25, event, cens.code=&amp;quot;censored&amp;quot;) ~ sex, data = Melanoma)
summary(CompRskAnalysis2)
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;

----------&amp;gt; Cause:  death.malignant.melanoma

sex=Female :
     time n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.0274    126       0      0  0.000    0.0000 0.0000 0.000
2  4.1424    104       0      0  0.127    0.0297 0.0688 0.185
3  5.4921     67       0      0  0.181    0.0351 0.1120 0.250
4  8.3272     34       0      0  0.236    0.0423 0.1528 0.318
5 15.2361      1       0      1  0.284    0.0519 0.1826 0.386

sex=Male :
     time n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.0274     79       0      0  0.000    0.0000 0.000 0.000
2  4.1424     51       0      0  0.270    0.0503 0.171 0.368
3  5.4921     35       0      0  0.310    0.0527 0.207 0.413
4  8.3272     18       0      0  0.425    0.0644 0.298 0.551
5 15.2361      0       0      0     NA        NA    NA    NA



----------&amp;gt; Cause:  death.other.causes

sex=Female :
     time n.risk n.event n.lost cuminc se.cuminc   lower  upper
1  0.0274    126       0      0 0.0000    0.0000 0.00000 0.0000
2  4.1424    104       0      0 0.0317    0.0156 0.00113 0.0624
3  5.4921     67       0      0 0.0398    0.0175 0.00562 0.0741
4  8.3272     34       0      0 0.0522    0.0212 0.01073 0.0937
5 15.2361      1       0      1 0.0854    0.0383 0.01027 0.1605

sex=Male :
     time n.risk n.event n.lost cuminc se.cuminc   lower  upper
1  0.0274     79       1      0 0.0127    0.0126 0.00000 0.0373
2  4.1424     51       0      0 0.0510    0.0248 0.00230 0.0996
3  5.4921     35       0      0 0.0669    0.0291 0.00992 0.1240
4  8.3272     18       0      0 0.0669    0.0291 0.00992 0.1240
5 15.2361      0       0      0     NA        NA      NA     NA
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;plot-survival-curve-of-competing-risk-analysis-with-prodlim--default&#34;&gt;Plot survival curve of competing risk analysis with prodlim (default)&lt;/h2&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;# Default plot
plot(CompRskAnalysis2)
&lt;/code&gt;&lt;/pre&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/DefaultPlot.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/DefaultPlot.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;h2 id=&#34;plot-survival-curve-of-competing-risk-analysis-with-prodlim--modified&#34;&gt;Plot survival curve of competing risk analysis with prodlim (modified)&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;adjust legend&lt;/li&gt;
&lt;li&gt;add tick-mark at right censoring times&lt;/li&gt;
&lt;li&gt;rotate labels of y-axis&lt;/li&gt;
&lt;li&gt;add statistical significance from results of cuminc described above&lt;/li&gt;

&lt;li&gt;&lt;p&gt;etc&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-R&#34;&gt;# Plot with modification
plot(CompRskAnalysis2,
 cause = &amp;quot;death.malignant.melanoma&amp;quot;,
 xlim=c(0, 15),
 legend.x=&amp;quot;topleft&amp;quot;, # position of legend
 legend.cex=1.5, # font size of legend
 marktime = TRUE, # the curves are tick-marked at right censoring times by invoking the function markTime.
 legend.title=&amp;quot;&amp;quot;,
 atrisk.title=&amp;quot;&amp;quot;,
 axis2.at=seq(0,1,0.2),
 background.horizontal=seq(0,1,0.2),
 axis2.las=2,                            # rotate labels of y-axis
 percent = FALSE,
 confint = FALSE,
 atrisk.col=&amp;quot;black&amp;quot;,
 xlab=&amp;quot;Time to primary outcome (years)&amp;quot;
 )
text(6.5,0.85,adj=0,paste(&amp;quot;Gray&#39;s test: p-value=&amp;quot;, round(Results_cmprsk$Tests[1,2],3)), cex = 1.2)
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;







&lt;figure&gt;

  &lt;a data-fancybox=&#34;&#34; href=&#34;/ox-hugo/ModifiedPlot.png&#34; &gt;

&lt;img src=&#34;/ox-hugo/ModifiedPlot.png&#34; &gt;
&lt;/a&gt;

&lt;/figure&gt;


&lt;p&gt;今回は，学会発表用のグラフ作成に必要であった．忘れないうちにまとめておく．以前は，at risk tableを別途作成してグラフに合体させるという荒業を行っていたが，これで非常に楽になった．&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>RをMac OSX (Sierra)にbrewでinstallしていて，upgradeしてハマったときの対処法</title>
      <link>/post/r_homebrew_update_error/</link>
      <pubDate>Sat, 27 Oct 2018 00:00:00 +0900</pubDate>
      <guid>/post/r_homebrew_update_error/</guid>
      <description>

&lt;p&gt;&lt;a href=&#34;https://www.r-project.org&#34; target=&#34;_blank&#34;&gt;R&lt;/a&gt;とは，オープンソース・フリーソフトウェアの統計解析向けのプログラミング言語及びその開発実行環境である（Wikipediaより）．org-modeと同じくらい必要不可欠なRではあるが，定期的にupdateする必要がある．いや，まぁ，したほうが良い，というか，しないと新しいパッケージが試せなかったりするので，しないではいられない．しかし，updateすると，たいていどこかでハマる．そこで，今回は，ハマったときの対処法を自分のためにまとめておくことにする．ハマるのはbioconductorの方が多いような気がする．ちなみに当方の環境は，MacBook Pro (15-inch, Late 2016) macOS Sierra 10.12.6である．先日もRを3.5.1にupdateしてハマったばかりである&amp;hellip;..(^^;;;&lt;/p&gt;

&lt;h2 id=&#34;gccのリンク絡みのトラブル&#34;&gt;gccのリンク絡みのトラブル&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;大体は以下で直ることが多い（&lt;a href=&#34;https://github.com/Homebrew/homebrew-science/issues/5587&#34; target=&#34;_blank&#34;&gt;r has dependency on gcc@6, but only lists gcc (which has updated to 7) #5587&lt;/a&gt;）&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;$ brew link --overwrite gcc
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;xmlが入らない&#34;&gt;XMLが入らない&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;XMLを入れるのが目的ではなく，なにか別のパッケージをインストールしようとして，それがXMLに依存しており，XMLを入れようとしてハマることが多いと思う．エラーメッセージは，configure: error: “libxml not found”である．しかし，homebrewで，brew listしてみると，libxml2はインストールされている．このあたりは，&lt;a href=&#34;https://medium.com/biosyntax/installing-r-package-xml-on-macos-10-13-6-1738146d4ee0&#34; target=&#34;_blank&#34;&gt;Installing R package XML on MacOS 10.13.6&lt;/a&gt;と同じである．対処法は，同サイトや引用元の&lt;a href=&#34;https://stackoverflow.com/questions/40682615/cannot-install-xml-package-in-r&#34; target=&#34;_blank&#34;&gt;Cannot install XML package in r&lt;/a&gt;にある通り，以下のようにコンパイラーに正しいxml2-configの場所を教えてやれば良い．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-shell&#34;&gt;Sys.setenv(XML_CONFIG = &amp;quot;/usr/local/Cellar/libxml2/2.9.7/bin/xml2-config&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;なお，上記を入力するのはRのコンソールである．通常のterminalにexportで入力しても効かないので注意すること！（これでどれだけ時間を無駄にしたことか．．．(ToT)）&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;cairoなどのインストール時に-include-and-lt-x11-xlib-dot-h-and-gt-でハマる&#34;&gt;Cairoなどのインストール時に，#include &amp;lt;X11/Xlib.h&amp;gt; でハマる．&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&amp;lsquo;X11/Xlib.h&amp;rsquo; file not found, #include &amp;lt;X11/Xlib.h&amp;gt; のようなエラーが出てコンパイルできないことがある（例えば，&amp;rdquo;Cairo&amp;rdquo; packageなど）．要するにXlib.hの在り処が分からんということである．mdfind（Mac版のlocate）で探してみると，以下のような結果が得られる．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ mdfind -name Xlib.h | grep X11
/opt/X11/include/cairo/cairo-xlib.h
/opt/X11/include/X11/Xlib.h
/System/Library/Frameworks/Tk.framework/Versions/8.4/Headers/X11/Xlib.h
/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers/X11/Xlib.h
/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk/System/Library/Frameworks/Tk.framework/Versions/8.5/Headers/X11/Xlib.h
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;そこで，目的のXlib.hは，/opt/X11/include/X11/Xlib.hと分かるので，include directoryにこれを含めるように指示すれば良い．これも，前項と同じく，Rのコンソールに入力すること！（これでどれだけ．．．以下同文）&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;Sys.setenv(C_INCLUDE_PATH = &amp;quot;/opt/X11/include&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これで，コンパイルできるようになるはずである．&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;どこにX11/Xlib.hが入っているかは，インストールの仕方により色々であろうから，場所を確認してから上記の操作を行うようにする．&lt;/p&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;なお，ネットのあちこちに，Xquartzをdowngradeすればコンパイルできる，みたいなことが書いてあったが，あれはなんなのだろうか．．．？&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;rsvgのインストール時に-xcb-shm-dot-pcがないと怒られる&#34;&gt;rsvgのインストール時に，xcb-shm.pcがないと怒られる．&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;こんな感じである．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;&amp;gt; biocLite(&amp;quot;rsvg&amp;quot;)
...................................
Package xcb-shm was not found in the pkg-config search path.
Perhaps you should add the directory containing `xcb-shm.pc&#39;
to the PKG_CONFIG_PATH environment variable
Package &#39;xcb-shm&#39;, required by &#39;cairo&#39;, not found
Found INCLUDE_DIR and/or LIB_DIR!
Using PKG_CFLAGS=-I/usr/local/Cellar/librsvg/2.40.20/lib/pkgconfig/librsvg-2.0.pc
Using PKG_LIBS=-L/usr/local/Cellar/librsvg/2.40.20/lib/pkgconfig -lrsvg
------------------------- ANTICONF ERROR ---------------------------
Configuration failed because librsvg-2.0 was not found. Try installing:
​* deb: librsvg2-dev (Debian, Ubuntu, etc)
​* rpm: librsvg2-devel (Fedora, EPEL)
​* csw: librsvg_dev, sunx11_devel (Solaris)
​* brew: librsvg (OSX)
If librsvg-2.0 is already installed, check that &#39;pkg-config&#39; is in your
PATH and PKG_CONFIG_PATH contains a librsvg-2.0.pc file. If pkg-config
is unavailable you can set INCLUDE_DIR and LIB_DIR manually via:
R CMD INSTALL --configure-vars=&#39;INCLUDE_DIR=... LIB_DIR=...&#39;
--------------------------------------------------------------------
ERROR: configuration failed for package ‘rsvg’
​* removing ‘/usr/local/Cellar/r/3.5.1/lib/R/library/rsvg’

The downloaded source packages are in
‘/private/var/folders/rq/hj_634613dbfzs41djqt52y80000gn/T/RtmpzsGqp0/downloaded_packages’
Updating HTML index of packages in &#39;.Library&#39;
Making &#39;packages.html&#39; ... done
警告メッセージ:
install.packages(pkgs = doing, lib = lib, ...) で:
installation of package ‘rsvg’ had non-zero exit status
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;要するに，xcb-shm.pcのあるディレクトリをPKG＿CONFIG＿DIRに追加しろと言ってるので，xcb-shm.pcがどこにあるかをmdfindで探してから，言われるとおり追加する．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;$ mdfind -name xcb-shm.pc
/opt/X11/lib/pkgconfig/cairo-xcb-shm.pc
/opt/X11/lib/pkgconfig/xcb-shm.pc
/usr/local/Cellar/cairo/1.14.8/lib/pkgconfig/cairo-xcb-shm.pc
/usr/local/Cellar/cairo/1.14.10/lib/pkgconfig/cairo-xcb-shm.pc
/usr/local/Cellar/cairo/1.14.12/lib/pkgconfig/cairo-xcb-shm.pc
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;上記のように，/opt/X11/lib/pkgconfig/xcb-shm.pcとなっているので，これを追加する．このときも上述のごとく，RのコンソールでSys.setenvを使う．&lt;/p&gt;

&lt;pre&gt;&lt;code class=&#34;language-sh&#34;&gt;&amp;gt; Sys.setenv(PKG_CONFIG_PATH = &amp;quot;/opt/X11/lib/pkgconfig&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;

&lt;li&gt;&lt;p&gt;これで，rsvgはうまくコンパイルされる．&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;今回はいきなりのRネタになってしまった．&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
